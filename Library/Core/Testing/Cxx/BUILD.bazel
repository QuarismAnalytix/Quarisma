# =============================================================================
# Quarisma Core Library Tests BUILD Configuration
# =============================================================================
# Test targets for Core library using GoogleTest
# Equivalent to Library/Core/Testing/Cxx/CMakeLists.txt
# =============================================================================

load("//bazel:quarisma.bzl", "quarisma_copts", "quarisma_defines", "quarisma_linkopts")

package(default_visibility = ["//visibility:public"])

# =============================================================================
# Test Files
# =============================================================================

# Core test files (non-GPU, non-profiler specific)
_CORE_TEST_FILES = [
    "TestAllocatorBfc.cpp",
    "TestAllocatorPool.cpp",
    "TestAllocatorStatistics.cpp",
    "TestAllocatorTracking.cpp",
    "TestAsciiVisualizer.cpp",
    "TestBackTrace.cpp",
    "TestCPUMemory.cpp",
    "TestCPUMemoryStats.cpp",
    "TestCPUinfo.cpp",
    "TestException.cpp",
    "TestFlatHash.cpp",
    "TestHashUtil.cpp",
    "TestLazy.cpp",
    "TestLogger.cpp",
    "TestLoggerThreadName.cpp",
    "TestParallelApi.cpp",
    "TestParallelFor.cpp",
    "TestParallelGuard.cpp",
    "TestParallelReduce.cpp",
    "TestPointer.cpp",
    "TestProfiler.cpp",
    "TestProfilerAnalysis.cpp",
    "TestProfilerAnnotationParsing.cpp",
    "TestProfilerAnnotationStack.cpp",
    "TestProfilerBackendIntegration.cpp",
    "TestProfilerChromeTraceHierarchical.cpp",
    "TestProfilerExporters.cpp",
    "TestProfilerFormatUtils.cpp",
    "TestProfilerMemoryAndStats.cpp",
    "TestProfilerPlatform.cpp",
    "TestProfilerStatsCalculator.cpp",
    "TestProfilerTimespan.cpp",
    "TestProfilerUtils.cpp",
    "TestProfilerXPlane.cpp",
    "TestProfilerXPlaneVisitor.cpp",
    "TestSMP.cpp",
    "TestSMPComprehensive.cpp",
    "TestSMPEnhanced.cpp",
    "TestSMPTransformFillSort.cpp",
    "TestSanitizers.cpp",
    "TestScopedMemoryDebugAnnotation.cpp",
    "TestParallelAdvancedParallelThreadPoolNative.cpp",
    "TestParallelAdvancedThreadName.cpp",
    "TestParallelAdvancedThreadPool.cpp",
    "TestStringUtil.cpp",
    "TestThreadPool.cpp",
    "TestTraceme.cpp",
    "TestXPlaneBuilder.cpp",
    "TestXPlaneSchema.cpp",
    "TestXPlaneUtils.cpp",
    "TestQuarismaProfiler.cpp",
]

# =============================================================================
# Core Tests Target
# =============================================================================

cc_test(
    name = "CoreCxxTests",
    size = "large",
    timeout = "long",  # Increase timeout for profiler tests
    srcs = _CORE_TEST_FILES,
    copts = quarisma_copts(),
    defines = quarisma_defines() + [
        "QUARISMA_GOOGLE_TEST",
        "USE_GTEST",
        "_VARIADIC_MAX=10",
        "QUARISMA_HAS_GTEST=1",
    ] + select({
        "//bazel:enable_cuda": ["QUARISMA_HAS_CUDA=1"],
        "//conditions:default": ["QUARISMA_HAS_CUDA=0"],
    }) + select({
        "//bazel:enable_hip": ["QUARISMA_HAS_HIP=1"],
        "//conditions:default": ["QUARISMA_HAS_HIP=0"],
    }) + select({
        "//bazel:enable_kineto": ["QUARISMA_HAS_KINETO=1"],
        "//conditions:default": ["QUARISMA_HAS_KINETO=0"],
    }),
    includes = ["."],
    linkopts = quarisma_linkopts(),
    deps = [
        "//Library/Core:Core",
        "//Library/Core/Testing:quarismaTest_header",
        "@com_google_googletest//:gtest",
        "@com_google_googletest//:gtest_main",
    ],
)

