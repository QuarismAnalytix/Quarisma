# =============================================================================
# Quarisma Bazel Configuration
# =============================================================================
# Build flags, compiler options, and platform-specific settings
# Equivalent to CMake compiler flags and build type configurations
# =============================================================================

# =============================================================================
# Common Build Flags
# =============================================================================

# Enable WORKSPACE file for compatibility with Bazel 8
# WORKSPACE is disabled by default in Bazel 8, but we need it for local third-party dependencies
# This flag enables both MODULE.bazel (Bzlmod) and WORKSPACE to work together
build --enable_workspace

build --enable_platform_specific_config
build --cxxopt=-std=c++17
build --host_cxxopt=-std=c++17
build --experimental_repo_remote_exec

# Enable colored output
build --color=yes

# =============================================================================
# C++ Standard Selection
# =============================================================================
# Default is C++17 (set above)
# Use --cxxopt=-std=c++XX to override at command line

# C++17 (default)
build:cxx17 --cxxopt=-std=c++17
build:cxx17 --host_cxxopt=-std=c++17

# C++20
build:cxx20 --cxxopt=-std=c++20
build:cxx20 --host_cxxopt=-std=c++20

# C++23
build:cxx23 --cxxopt=-std=c++23
build:cxx23 --host_cxxopt=-std=c++23

# =============================================================================
# Optimization Levels
# =============================================================================

# Debug configuration (equivalent to CMAKE_BUILD_TYPE=Debug)
build:debug --compilation_mode=dbg
build:debug --copt=-O0
build:debug --copt=-g
build:debug --strip=never

# Release configuration (equivalent to CMAKE_BUILD_TYPE=Release)
build:release --compilation_mode=opt
build:release --copt=-O3
build:release --copt=-DNDEBUG
build:release --strip=always

# RelWithDebInfo configuration
build:relwithdebinfo --compilation_mode=opt
build:relwithdebinfo --copt=-O2
build:relwithdebinfo --copt=-g
build:relwithdebinfo --copt=-DNDEBUG
build:relwithdebinfo --strip=never

# =============================================================================
# Link Time Optimization (LTO)
# =============================================================================
build:lto --copt=-flto=thin
build:lto --linkopt=-flto=thin

# =============================================================================
# Vectorization Options (equivalent to QUARISMA_VECTORIZATION_TYPE)
# =============================================================================

# SSE vectorization
build:sse --copt=-msse
build:sse --copt=-msse2
build:sse --copt=-msse3
build:sse --copt=-mssse3
build:sse --copt=-msse4.1
build:sse --copt=-msse4.2

# AVX vectorization
build:avx --copt=-mavx
build:avx --copt=-msse4.2

# AVX2 vectorization (default)
build:avx2 --copt=-mavx2
build:avx2 --copt=-mfma
build:avx2 --copt=-mavx
build:avx2 --copt=-msse4.2

# AVX512 vectorization
build:avx512 --copt=-mavx512f
build:avx512 --copt=-mavx512cd
build:avx512 --copt=-mavx512bw
build:avx512 --copt=-mavx512dq
build:avx512 --copt=-mavx512vl

# =============================================================================
# Compiler-Specific Configurations
# =============================================================================
# Note: Bazel uses auto-detected toolchains (local_config_cc).
# These configs are primarily for documentation and future extensibility.
# The actual compiler is determined by the system's available toolchain.
# We do NOT add compiler-specific flags here to avoid conflicts with the
# actual compiler being used by Bazel's auto-detection.

# Clang compiler configuration (uses system Clang if available)
build:clang --cxxopt=-std=c++17

# GCC compiler configuration (uses system GCC if available)
build:gcc --cxxopt=-std=c++17

# MSVC compiler configuration (uses system MSVC if available)
build:msvc --cxxopt=-std=c++17

# Xcode configuration (macOS with Clang)
build:xcode --apple_platform_type=macos
build:xcode --cxxopt=-stdlib=libc++
build:xcode --cxxopt=-std=c++17

# =============================================================================
# Platform-Specific Configurations
# =============================================================================

# macOS specific settings
build:macos --cxxopt=-stdlib=libc++
build:macos --cxxopt=-faligned-allocation
build:macos --cxxopt=-mmacosx-version-min=10.13
build:macos --linkopt=-undefined
build:macos --linkopt=dynamic_lookup

# Linux specific settings
build:linux --cxxopt=-pthread
build:linux --linkopt=-pthread
build:linux --linkopt=-ldl
build:linux --linkopt=-lrt

# Windows specific settings (MSVC)
build:windows --copt=/std:c++17
build:windows --copt=/W4
build:windows --copt=/EHsc
build:windows --define=_WIN32_WINNT=0x0A00

# =============================================================================
# Sanitizer Configurations
# =============================================================================

# Address Sanitizer
build:asan --strip=never
build:asan --copt=-fsanitize=address
build:asan --copt=-fno-omit-frame-pointer
build:asan --linkopt=-fsanitize=address

# Thread Sanitizer
build:tsan --strip=never
build:tsan --copt=-fsanitize=thread
build:tsan --copt=-fno-omit-frame-pointer
build:tsan --linkopt=-fsanitize=thread

# Undefined Behavior Sanitizer
build:ubsan --strip=never
build:ubsan --copt=-fsanitize=undefined
build:ubsan --copt=-fno-omit-frame-pointer
build:ubsan --linkopt=-fsanitize=undefined

# Memory Sanitizer
build:msan --strip=never
build:msan --copt=-fsanitize=memory
build:msan --copt=-fno-omit-frame-pointer
build:msan --linkopt=-fsanitize=memory

# =============================================================================
# Feature Flags (equivalent to QUARISMA_ENABLE_* options)
# =============================================================================

# Enable CUDA support
build:cuda --define=quarisma_enable_cuda=true
build:cuda --crosstool_top=@local_config_cuda//crosstool:toolchain

# Enable HIP support
build:hip --define=quarisma_enable_hip=true

# Enable OpenMP
build:openmp --copt=-fopenmp
build:openmp --linkopt=-fopenmp

# Enable TBB
build:tbb --define=quarisma_enable_tbb=true

# Enable MKL
build:mkl --define=quarisma_enable_mkl=true

# Enable mimalloc
build:mimalloc --define=quarisma_enable_mimalloc=true

# Enable magic_enum
build:magic_enum --define=quarisma_enable_magic_enum=true

# Enable Kineto profiling
# Note: Kineto config also enables native profiler for compatibility with tests
build:kineto --define=quarisma_profiler_type=kineto --define=quarisma_enable_kineto=true

# Enable native profiler
build:native_profiler --define=quarisma_profiler_type=native

# Enable ITT profiling
build:itt --define=quarisma_profiler_type=itt --define=quarisma_enable_itt=true

# Enable LU pivoting
build:lu_pivoting --define=quarisma_lu_pivoting=true

# Enable Sobol 1111 dimensions
build:sobol_1111 --define=quarisma_sobol_1111=true

# =============================================================================
# Testing Configuration
# =============================================================================
test --test_output=errors
test --test_summary=detailed

# Enable Google Test
build:gtest --define=quarisma_enable_gtest=true

# Enable Google Benchmark
build:benchmark --define=quarisma_enable_benchmark=true

# =============================================================================
# Code Coverage
# =============================================================================
coverage --combined_report=lcov
coverage --instrument_test_targets
coverage --experimental_use_llvm_covmap

# =============================================================================
# Logging Backend Selection
# =============================================================================
build:logging_glog --define=quarisma_logging_backend=glog
build:logging_loguru --define=quarisma_logging_backend=loguru
build:logging_native --define=quarisma_logging_backend=native

# =============================================================================
# GPU Allocation Strategy
# =============================================================================
build:gpu_alloc_sync --define=quarisma_gpu_alloc=sync
build:gpu_alloc_async --define=quarisma_gpu_alloc=async
build:gpu_alloc_pool_async --define=quarisma_gpu_alloc=pool_async

# =============================================================================
# Windows-Specific Configuration
# =============================================================================
# Use cmd.exe for genrule commands on Windows
build:windows --shell_executable=cmd.exe

# =============================================================================
# Default Configuration
# =============================================================================
# Import user-specific configuration
try-import %workspace%/.bazelrc.user
